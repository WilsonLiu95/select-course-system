# 选课系统架构设计
## 整体说明
全系一级学生400左右，抢课主要问题在于 高并发 带来的 **各种系统过载** 与 **对同一数据修改造成的矛盾**。
### 系统设计原则
1. 满足当前需求
2. 应对日后需求变更，系统架构设计无需大改，仅仅修改具体处理逻辑接口即可
3. 性能上，可以通过横向叠加机器满足更多院系乃至更多多个学校的抢课需求。
### 主要解决方案
1. 提前开放注册与查看可选的课程，将此部分操作提前。
2. 设置前端资源缓存，减小系统请求文件的流量，并且由于是提前开发，不至于在高并发抢课时，带来文件流量爆发，压力主要在于AJAX请求。
3. AJAX请求不落到DB层面，而是对cache进行操作，并异步落入到DB中。以防止DB压力过大。
4. 引入队列，解决并发对同一数据修改造成矛盾的问题。并通过`hash环`允许横向增加队列数量来加速任务处理。
5. 选课操作由同步转换为异步操作，减少后台并发的PHP进程数量。

## 选课流程设计 —— 同步逻辑异步化

选课的关键在于，选中该课程的人数是否达到上限。

用户首先选择专业方向，进入该专业方向的选课页面,选课页面为一个 `checkList`。(选专业方向不限制人数)

用户勾选多门课程，点击选定按钮，发送请求。或者点击退选按钮，一次性退选多门课程。(由用户自己计算是否达到要求的学分)

### 前端部分
选课时，可同时勾选X门课程(X 不大于 Y 门课程,Y 可由系统设置)。勾选后，点击确认发送http请求给后端。后端接收到请求，分发选课任务后直接返回响应。
收到响应后，表示请求成功，处于抢课中，弹出"选课ing~"动画，请耐心等候。此时，以300ms的频率轮询后端接口，查看选课情况。

轮询响应情况分为几种
1. 全部选上 -- 清除轮询，关闭"选课ing~"动画，弹出恭喜弹窗。
2. 部分课程没选上 -- 清除轮询，关闭"选课ing~"动画，弹出弹窗，提示哪几门课程没选上
3. 本次选的X门课程，后端未完全处理完。 -- "选课ing~"动画继续，继续轮询

### 后端部分
收到请求后，将单个请求中的多个课程选项根据课程的ID分发到相应队列中去。分发后直接返回分发成功的响应。
同时，将此次请求的数据记录在cache中。
```
// 学生选课的情况.减小粒度避免并发写
selectDetail-22-12:{ // 命名结构为 "selectDetail_"  + student_id  + "_"+course_id
    isSelect: false,// 是否选上该门课程
    isFinish: true, // 任务是否完成
    }
```
每个任务完成之后，去缓存中查找对应的`selectDetail`，并将对应的`isFinish`置为true，同时，根据选中与否修改`isSelect`。
前端轮询请求时，`selectDetail`数组中所有项的`isFinish`都为`true`，表示全部任务执行完成，返回选课成功与否的情况。
否则对应情况3，返回响应让前端"选课ing~"动画继续。

注:因此，X 门课程互不影响选中与否的情况，只根据运行到该任务时，课程是否已被选满有关。

## 队列
队列解决了并行枪占同一资源的问题。同时，可以在抢占不同资源时通过压入不同的队列来提高并行效率。

当前课程类型分为四种
1. 只属于公选课
2. 只属于单个专业方向的选修课
3. 属于多个专业方向的选修课
4. 同时属于N个专业方向与选修课(这里N大于1，与等于1视作同一种情况考虑)

选专业方向时，目前的策略是选中一个专业方向后，即系统自动选中该方向下所有课程。
而各个方向可能同时依赖于一个课程，需要串行处理，因此用一个队列处理。

注：等到日后，课程丰富取消选方向即全选策略后，则选方向不做限制，先选中方向，再选方向下的具体课程，自己来衡量是否修够了学分，如果无法修够学分，可自行退选。
而选课逻辑与公选课选课逻辑一致。

等待选公选课的时候，则可以设置 N 个队列，将 M 门课程通过 `hash环`原理压入不同的队列。

## cache -- 抗压并异步落到DB中
所有操作都提升到cache层面，进行操作。通过laravel的的缓存tags将一个院系的数据统一在一个tags下 `'ins' + institute_id`

```
// 课程在cache中的键名结构为 "course_" + course_id  

// 键名主要考虑首先 表明身份为课程， 其次，具体课程都属于具体学院之下(以后根据需求，可以加上grade_id等)
//======================================== 类型为整数。缓存数据为 人数 ================================================
direction_student_num_21: 24; // 当前该方向的人数 "direction_student_num_" + direction_id

// 根据以下两个数据与 course_required_num 中该课程的课程容量进行比较，决定后续的操作，是否丢弃之后的选课请求。
// 当前默认请求超过10个就自动当成没有选上。

course_has_select_num_21: 23; // 当前选定该课程的人数 
course_wait_select_num_21: 2; // 当前选定该门课程但是仍排在队列中的人数

//======================================== 缓存各种数据详情 ================================================
course_required_num:[ // 课程要求的人数映射表
    2:50,
    3:30,
]
major_direction_map:{ // 存储专业与专业方向的映射关系,格式为 “major_direction_map” 
    0: [ // 专业ID为0表示不受限制，可以选择该学院下所有专业方向
        {id:1,name:"互联网"}, // direction_id为key
        {id:3,name:"数据挖掘"}
    ],
    1: [  // key为专业ID 数组中为该专业可以选择专业方向
        {id:1,name:"互联网"}, 
        {id:3,name:"数据挖掘"}  
    ]
}

// 方向的数据
direction_21:  [
    {id:2,title:"互联网导论2",credit:2,teacher:"许炜,required_number:30", current_number:12}
    ] // 存储具体课程信息，这部分是吐出给展示



// major_id为0表示可以选择所有方向的课程
major_course_0:[ // 存储该学院各个专业可以选择的方向及其对应的课程,格式为 “major_course_” +  + major_id
    {
        id: 1,
        name: "互联网",
        course:[{
            id:1,
            name:"Java程序设计",
            credit:2,
            teacher: "许炜",
            required_number: 80,
        },{
            id:1,
            name:"前端开发",
            credit:3,
            teacher: "许炜",
            required_number: 70,
        }]
    },{
        id:2,
        name: "数据挖掘",
        course: [{
            id:4,
            name:"图像处理",
            credit:2,
            teacher: "许炜",
            required_number: 60,
        },]
    }
]

// 学生选课的情况.减小粒度避免并发写
selectResult_22_12:{ // 命名结构为 "selectDetail_"  + student_id  + "_"+course_id
    isSelect: false,// 是否选上该门课程
    isFinish: true, // 任务是否完成
    }

```

## session
```
{
    openid: onu__wlCgn1pon2PULOkpBelgZvs, // 微信的openid
    // 用户基础信息部分
    account:{
        // 用户id字段
        id:2, 
        openid: "onu__wlCgn1pon2PULOkpBelgZvs",
        institute_id: 1,
        major_id: 3,
        grade_id: 1,
        class_id: 5,
        direction_id: 0,

        // 基本信息
        name: "刘盛",
        institute: "电信学院",
        major: "通信工程",
        grade: "本科2013",
        class: "通信1305班",
        job_num: "U201313759", // 学号
        direction: "互联网"
    }
    // 与用户操作相关的数据
    isAbleSelect: false, // 是否可选课程，用户同时只可提交一次选课操作，不可频繁提交选课操作。
    queue_course: [] // 本次用户操作的课程
    has_select_common_course: [11,23,33] // 选中的课程ID
    has_select_direction_course: [] // 选择的选修课程ID
}

```