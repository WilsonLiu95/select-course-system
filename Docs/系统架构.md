# 选课系统架构设计
## 整体说明
全系一级学生400左右，抢课主要问题在于 高并发 带来的 **各种系统过载** 与 **对同一数据修改造成的矛盾**。
### 系统设计原则
1. 满足当前需求
2. 应对日后需求变更，系统架构设计无需大改，仅仅修改具体处理逻辑接口即可
3. 性能上，可以通过横向叠加机器满足更多院系乃至更多多个学校的抢课需求。
### 主要解决方案
1. 提前开放注册与查看可选的课程，将此部分操作提前。
2. 设置前端资源缓存，减小系统请求文件的流量，流量主要在于AJAX请求。(同时由于提前开发注册，流量不至于集中)
3. AJAX请求不落到DB层面，而是对cache进行操作，并异步落入到DB中。以防止DB压力过大。
4. 引入队列，解决并发对同一数据修改造成矛盾的问题。并通过`hash环`允许横向增加队列数量来加速任务处理。
5. 选课操作由同步转换为异步操作，减少后台并发的PHP进程数量。

## 选专业方向与选公选课
无论是抢专业方向还是抢公选课，最后都落到了选课上。
当前默认选专业方向，则直接全选该专业方向的所有课程，是因为刚刚开始以专业方向选课，许多专业方向下的课程刚刚符合学分要求，所以默认全选。
但是随着课程的丰富，势必会造成问题，需要支持用户自定义选择课程的需求。

而选课的关键在于，选中该课程的人数是否达到上限。

因此选中专业方向的同时，对该方向下的课程进行检查，如果所有课程都可选。则表示，可选中该专业方向。

## 队列
队列解决了并行枪占同一资源的问题。同时，可以在抢占不同资源时通过压入不同的队列来提高并行效率。

当前课程类型分为四种
1. 只属于公选课
2. 只属于单个专业方向的选修课
3. 属于多个专业方向的选修课
4. 同时属于N个专业方向与选修课(这里N大于1，与等于1视作同一种情况考虑)

选专业方向时，目前的策略是选中一个专业方向后，即系统自动选中该方向下所有课程。
而各个方向可能同时依赖于一个课程，需要串行处理，因此用一个队列处理。

注：等到日后，课程丰富取消选方向即全选策略后，则选方向不做限制，先选中方向，再选方向下的具体课程，自己来衡量是否修够了学分，如果无法修够学分，可自行退选。
而选课逻辑与公选课选课逻辑一致。

等待选公选课的时候，则可以设置 N 个队列，将 M 门课程通过 `hash环`原理压入不同的队列

## 选课流程设计 —— 同步逻辑异步化
### 前端部分
选课时，可同时勾选X门课程(X 不大于 Y 门课程,Y 可由系统设置)。勾选后，点击确认发送http请求给后端。后端接收到请求，分发选课任务后直接返回响应。
收到响应后，表示请求成功，处于抢课中，弹出"选课ing~"动画，请耐心等候。此时，以300ms的频率轮询后端接口，查看选课情况。

轮询响应情况分为几种
1. 全部选上 -- 清除轮询，关闭"选课ing~"动画，弹出恭喜弹窗。
2. 部分课程没选上 -- 清除轮询，关闭"选课ing~"动画，弹出弹窗，提示哪几门课程没选上
3. 本次选的X门课程，后端未完全处理完。 -- "选课ing~"动画继续，继续轮询

### 后端部分
收到请求后，将单个请求中的多个课程选项根据课程的ID分发到相应队列中去。分发后直接返回分发成功的响应。
同时，将此次请求的数据记录在cache中。
```
selectDetail-1-22:[{ // 命名结构为 "selectDetail" + institute_id + "_" + student_id  
    course_id: 1, 
    isSelect: true,
    isFinish: true,}，{
    course_id: 3,
    isSelect: false, // 是否选上该门课程
    isFinish: true, // 任务是否完成
}]
```
每个任务完成之后，去缓存中查找对应的`selectDetail`，并将对应的`isFinish`置为true，同时，根据选中与否修改`isSelect`。
前端轮询请求时，`selectDetail`数组中所有项的`isFinish`都为`true`，表示全部任务执行完成，返回选课成功与否的情况。
否则对应情况3，返回响应让前端"选课ing~"动画继续。

注:因此，X 门课程互不影响选中与否的情况，只根据运行到该任务时，课程是否已被选满有关。

## cache
所有操作都提升到cache层面，进行操作。目前cache中主要存储两种基本信息，课程与专业方向

```
// 课程在cache中的键名结构为 "course_"+ institute_id + "_" + course_id  
// 键名主要考虑首先 表明身份为课程， 其次，具体课程都属于具体学院之下(以后根据需求，可以加上grade_id等)
course_1_2:{
    detail:{
        title: "Java",
        maxSelectNum: 60,
        currentSelectNum: 57,
        credit: 2, // 学分
        teacher: '许炜'
        direction: '互联网',        
    },
    isCanSelect: true, 
    currentSelectList: {
        1: { // key为student_id
            isSelect: true,   // true代表当前选中，false代表选中后退选课程            
        } 
    }
    waitInsertDB:[1] // 等待被录入DB的选课情况，存储数据在`select_course`中
}

direction_1_21: { // 方向的数据
    isCanSelect: true,
    currentSelectNum: 37,
    courseMap:["course_1_2","course_1_3","course_1_12"], // 存储课程的映射，每次去对应课程中去获取相应数据吐给前端
    currentSelectList: {
        1:{ // key为student_id
            isSelect: true,
        },3:{
            isSelect: false,
        }
    }
    waitInsertDB:[1,3] // 等待被录入DB的专业方向选择情况,将数据存储在 `select_direction`
}

```

## session
```
{
    openid: onu__wlCgn1pon2PULOkpBelgZvs, // 微信的openid

    // 用户基础信息部分
    id: 2, // student_id
    institute_id: 1,
    major_id: 3,
    grade_id: 1,
    class_id: 5,
    detail:{
        name: "刘盛",
        institute: "电信学院",
        major: "通信工程",
        grade: "本科2013",
        class: "通信1305班",
        job_num: "U201313759", // 学号
        direction: "互联网"
    }
    // 一些经常用到的映射表
    canSelectDirection: [1,3,4],
    // 与用户操作相关的数据
    isLogin: true, // 表示是否登录
    isAbleSelect: false, // 是否可选课程，用户同时只可提交一次选课操作，不可频繁提交选课操作。
    direction_id: 3, // 选中的专业方向
    select_course_map: ["course_1_2","course_1_3","course_1_12"] // 选中的课程ID映射
}

```